# База данных

Состоит из следующих компонентов:
- ``DBConnector.ts`` - коннектор базы данных (драйвер)
- ``tables`` - описание таблиц в базе
- ``entityes`` - описание записей по таблицам
- ``getCurrentUser.ts`` - получение текущего пользователя из сессии (выделено для организации доступа)


## Свойства и методы базовых компонентов

### DBConnector

``private CRYPTO_KEY`` - ключ криптозащиты
``public pool:pg.Pool`` - пул соединений PostgreSQL
``constructor()`` - конструктор - создает подключение к базе и активироует пул соединений
``async begin():Promise<pg.PoolClient>`` - начало запроса - получить соединение из пула (ВАЖНО ДЛЯ НАПИСАНИЯ ЗАПРОСОВ САМОСТОЯТЕЛЬНО)
``async end(client:pg.PoolClient):Promise<Boolean>`` - окончание запроса - вернуть соединение обратно в пул (ВАЖНО ДЛЯ НАПИСАНИЯ ЗАПРОСОВ САМОСТОЯТЕЛЬНО)
``async Dectroy():Promise<Boolean>`` - правильное отключение от базы (ВАЖНО ДЛЯ ПРАВИЛЬНОГО ВЫХОДА)
``async Exec(q:any):Promise<Boolean>`` - выполнить простой запрос (не нужно применять begin и end)
``async Query(q:any):Promise<Array<any>>`` - выполнить запрос в базу данных с возвратом значений в виде строк (не нужно применять begin и end)
``async QueryOne(q:any):Promise<any>`` - выполнить запрос в базу данных с возвратом значений в виде единственной строки
``public sha256(str:string):string`` - зашифровать строку ключем криптозащиты (расшифровка не предусмотрена - работае с паролем)



``-``
``-``
``-``



## Особенности запросов с добавлением данных (как правильно получить ID)

Для получения идентификаторов добавленных данных (в PostgreSQL) можно использовать синтаксис добавления следующего типа:

```sql
INSERT INTO users_sessions (uid, key_uid, expires, sess_data) VALUES ($1, $2, $3, $4) RETURNING id;
```

В конце запроса идёт возврат идентификатора добавленной записи ``RETURNING id``.
Эта особенность SQL запросов позволяет избежать дополнительных обращений в базу для выявления идентификатора новой записи.

ПРИМЕР:
```js
var res_db = await this.db_conn.QueryOne({
    text:"INSERT INTO users_sessions (uid, expires) VALUES ($1, $2) RETURNING id",
    values:[1, new Date(Date.now() + (3600 * 24 * 1000)*15)]
});

console.log(res_db)
```
ВЕРНЁТ: ``{ id: '1' }``

